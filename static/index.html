<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI í´ë¼ìš°ë“œ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f3f4f6;
    }

    h1 {
      margin: 0 0 20px;
      font-size: 1.5rem;
      text-align: center;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 18px 20px 20px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 12px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: #6b7280;
    }

    canvas {
      width: 100% !important;
      height: 360px !important;
    }

    .status {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #6b7280;
      text-align: right;
    }

    /* AI ì¹´ë“œìš© ì¶”ê°€ ìŠ¤íƒ€ì¼ */
    .ai-card-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 0.9rem;
    }

    .ai-status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .ai-badge-ok {
      background: #dcfce7;
      color: #166534;
    }

    .ai-badge-warning {
      background: #fef9c3;
      color: #92400e;
    }

    .ai-badge-critical {
      background: #fee2e2;
      color: #b91c1c;
    }

    .ai-badge-unknown {
      background: #e5e7eb;
      color: #374151;
    }

    .ai-meta {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .ai-list {
      margin: 0;
      padding-left: 18px;
    }

    .ai-list li {
      margin-bottom: 4px;
    }

    .ai-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #111827;
      color: white;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .ai-alert-pill {
      font-size: 0.8rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .ai-footer {
      margin-top: 4px;
      font-size: 0.78rem;
      color: #6b7280;
      text-align: right;
    }

    .ai-error {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #b91c1c;
    }
  </style>
</head>
<body>
  <h1>EC2 CPU ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>

  <div class="container">
    <!-- 1. CloudWatch 5ë¶„ í‰ê·  ì¹´ë“œ -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">CloudWatch 5ë¶„ í‰ê· </div>
          <div class="card-subtitle">/cpu (ì§€ë‚œ 1ì‹œê°„ í‰ê·  CPUUtilization)</div>
        </div>
      </div>
      <canvas id="cloudwatchChart"></canvas>
      <div id="cloudwatchStatus" class="status"></div>
    </div>

    <!-- 2. ì‹¤ì‹œê°„ CPU ì¹´ë“œ -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">ì‹¤ì‹œê°„ CPU</div>
          <div class="card-subtitle">/cpu_live (1ì´ˆ ê°±ì‹ , ìµœëŒ€ 60ì´ˆ í‘œì‹œ)</div>
        </div>
      </div>
      <canvas id="liveCpuChart"></canvas>
      <div id="liveCpuStatus" class="status"></div>
    </div>

    <!-- 3. AI ìƒíƒœ ë¶„ì„ + ì•ŒëŒ ì¹´ë“œ -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">AI ìƒíƒœ ë¶„ì„ & ì•Œë¦¼</div>
          <div class="card-subtitle">
            /analyze (CloudWatch ë©”íŠ¸ë¦­ + Haiku ë¶„ì„ + SNS ì•Œë¦¼)
          </div>
        </div>
        <div class="ai-buttons">
          <button id="analyzeBtn" class="btn" onclick="fetchAnalyze()">
            ğŸ” AIë¡œ ìƒíƒœ ë¶„ì„í•˜ê¸°
          </button>
          <button id="analyze60Btn" class="btn btn-secondary" onclick="fetchAnalyze(60)">
            ìµœê·¼ 60ë¶„ ê¸°ì¤€
          </button>
          <button id="analyze240Btn" class="btn btn-secondary" onclick="fetchAnalyze(240)">
            ìµœê·¼ 4ì‹œê°„ ê¸°ì¤€
          </button>
        </div>
      </div>

      <div class="ai-card-content">
        <div class="ai-status-row">
          <div id="aiStatusBadge" class="ai-badge ai-badge-unknown">
            ìƒíƒœ ë¯¸ë¶„ì„
          </div>
          <div id="aiMeta" class="ai-meta">
            ì•„ì§ ë¶„ì„ì„ ì‹¤í–‰í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
          </div>
        </div>

        <div>
          <strong>ìš”ì•½</strong>
          <div id="aiSummary" style="margin-top: 4px; font-size: 0.9rem; color: #111827;">
            ë²„íŠ¼ì„ ëˆŒëŸ¬ í˜„ì¬ ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœë¥¼ ë¶„ì„í•´ë³´ì„¸ìš”.
          </div>
        </div>

        <div>
          <strong>ì˜ì‹¬ë˜ëŠ” ì›ì¸</strong>
          <ul id="aiCauses" class="ai-list">
            <!-- ë™ì  ìƒì„± -->
          </ul>
        </div>

        <div>
          <strong>ê¶Œì¥ ì¡°ì¹˜</strong>
          <ul id="aiActions" class="ai-list">
            <!-- ë™ì  ìƒì„± -->
          </ul>
        </div>

        <div id="aiAlertInfo" class="ai-alert-pill" style="display:none;">
          ğŸ”” ì•ŒëŒ: ì•„ì§ ë°œì†¡ë˜ì§€ ì•ŠìŒ
        </div>

        <div id="aiError" class="ai-error"></div>

        <div id="aiFooter" class="ai-footer">
          ë§ˆì§€ë§‰ ë¶„ì„: - / ì•ŒëŒ ì¿¨ë‹¤ìš´ ì •ë³´: -
        </div>
      </div>
    </div>
  </div>

  <script>
    // ================================
    // ê³µí†µ: ìœ í‹¸ í•¨ìˆ˜
    // ================================
    function formatTimeLabel(isoString) {
      const d = new Date(isoString);
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      const ss = String(d.getSeconds()).padStart(2, "0");
      return `${hh}:${mm}:${ss}`;
    }

    // ìƒíƒœ ë±ƒì§€ ìŠ¤íƒ€ì¼ ë³€ê²½
    function setAiStatusBadge(status) {
      const badge = document.getElementById("aiStatusBadge");
      badge.className = "ai-badge"; // ê¸°ë³¸ ì´ˆê¸°í™”

      let text = "";
      if (status === "OK") {
        badge.classList.add("ai-badge-ok");
        text = "ğŸŸ¢ ì •ìƒ (OK)";
      } else if (status === "WARNING") {
        badge.classList.add("ai-badge-warning");
        text = "ğŸŸ¡ ì£¼ì˜ (WARNING)";
      } else if (status === "CRITICAL") {
        badge.classList.add("ai-badge-critical");
        text = "ğŸ”´ ìœ„í—˜ (CRITICAL)";
      } else {
        badge.classList.add("ai-badge-unknown");
        text = "ìƒíƒœ ë¯¸ë¶„ì„";
      }
      badge.textContent = text;
    }

    function renderList(elementId, items) {
      const el = document.getElementById(elementId);
      el.innerHTML = "";
      if (!items || items.length === 0) {
        const li = document.createElement("li");
        li.textContent = "ì •ë³´ ì—†ìŒ";
        el.appendChild(li);
        return;
      }
      items.forEach((t) => {
        const li = document.createElement("li");
        li.textContent = t;
        el.appendChild(li);
      });
    }

    // ================================
    // 1. CloudWatch 5ë¶„ í‰ê·  ì°¨íŠ¸ (/cpu)
    // ================================
    const cloudwatchCtx = document
      .getElementById("cloudwatchChart")
      .getContext("2d");

    const cloudwatchChart = new Chart(cloudwatchCtx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "CPU (%)",
            data: [],
            borderWidth: 2,
            fill: false,
            tension: 0.15,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: "CPU Utilization (%)",
            },
          },
          x: {
            title: {
              display: true,
              text: "ì‹œê°„ (5ë¶„ í‰ê· )",
            },
            ticks: {
              autoSkip: true,
              maxTicksLimit: 12,
            },
          },
        },
        plugins: {
          legend: {
            display: false,
          },
        },
      },
    });

    async function fetchCloudwatchCpu() {
      const statusEl = document.getElementById("cloudwatchStatus");
      try {
        const res = await fetch("/cpu");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (data.status !== "ok") {
          statusEl.textContent = `CloudWatch ì‘ë‹µ ìƒíƒœ: ${data.status || "unknown"} (${data.message || ""})`;
          return;
        }

        const timestamps = data.timestamps || [];
        const values = data.values || [];

        cloudwatchChart.data.labels = timestamps.map((t) => {
          const d = new Date(t);
          const hh = String(d.getHours()).padStart(2, "0");
          const mm = String(d.getMinutes()).padStart(2, "0");
          return `${hh}:${mm}`;
        });
        cloudwatchChart.data.datasets[0].data = values;
        cloudwatchChart.update();

        const nowKst = new Date();
        statusEl.textContent = `ë§ˆì§€ë§‰ ê°±ì‹ : ${nowKst.toLocaleTimeString()} / ë°ì´í„° í¬ì¸íŠ¸: ${values.length}ê°œ`;
      } catch (err) {
        statusEl.textContent = `CloudWatch ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${err.message}`;
        console.error(err);
      }
    }

    setInterval(fetchCloudwatchCpu, 1000);
    fetchCloudwatchCpu();

    // ================================
    // 2. ì‹¤ì‹œê°„ CPU ì°¨íŠ¸ (/cpu_live)
    // ================================
    const liveCpuCtx = document
      .getElementById("liveCpuChart")
      .getContext("2d");

    const liveLabels = [];
    const liveValues = [];

    const liveCpuChart = new Chart(liveCpuCtx, {
      type: "line",
      data: {
        labels: liveLabels,
        datasets: [
          {
            label: "ì‹¤ì‹œê°„ CPU (%)",
            data: liveValues,
            borderWidth: 2,
            fill: false,
            tension: 0.15,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: "CPU Utilization (%)",
            },
          },
          x: {
            title: {
              display: true,
              text: "ì‹œê°„ (ìµœê·¼ 60ì´ˆ)",
            },
            ticks: {
              autoSkip: true,
              maxTicksLimit: 6,
            },
          },
        },
        plugins: {
          legend: {
            display: false,
          },
        },
      },
    });

    async function fetchLiveCpu() {
      const statusEl = document.getElementById("liveCpuStatus");
      try {
        const res = await fetch("/cpu_live");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (data.status !== "ok") {
          statusEl.textContent = `ì‹¤ì‹œê°„ ì‘ë‹µ ìƒíƒœ: ${data.status || "unknown"} (${data.message || ""})`;
          return;
        }

        const label = formatTimeLabel(data.timestamp);
        const value = Number(data.cpu_percent);

        liveLabels.push(label);
        liveValues.push(value);

        if (liveLabels.length > 60) {
          liveLabels.shift();
          liveValues.shift();
        }

        liveCpuChart.update();

        const nowKst = new Date();
        statusEl.textContent = `ë§ˆì§€ë§‰ ê°±ì‹ : ${nowKst.toLocaleTimeString()} / í¬ì¸íŠ¸: ${liveValues.length}ê°œ`;
      } catch (err) {
        statusEl.textContent = `ì‹¤ì‹œê°„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${err.message}`;
        console.error(err);
      }
    }

    setInterval(fetchLiveCpu, 1000);
    fetchLiveCpu();

    // ================================
    // 3. /analyze : AI ìƒíƒœ ë¶„ì„ + ì•ŒëŒ
    // ================================
    let lastAnalyzeAt = null;

    async function fetchAnalyze(minutes = 60) {
      const btnMain = document.getElementById("analyzeBtn");
      const btn60 = document.getElementById("analyze60Btn");
      const btn240 = document.getElementById("analyze240Btn");
      const aiMeta = document.getElementById("aiMeta");
      const aiSummary = document.getElementById("aiSummary");
      const aiError = document.getElementById("aiError");
      const aiFooter = document.getElementById("aiFooter");
      const aiAlertInfo = document.getElementById("aiAlertInfo");

      btnMain.disabled = true;
      btn60.disabled = true;
      btn240.disabled = true;
      aiError.textContent = "";
      aiMeta.textContent = "AIê°€ ë©”íŠ¸ë¦­ì„ ë¶„ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...";

      try {
        const res = await fetch(`/analyze?minutes=${minutes}`);
        const data = await res.json();

        if (!res.ok) {
          aiError.textContent = `HTTP ì˜¤ë¥˜: ${res.status} / ${data.message || ""}`;
          setAiStatusBadge(null);
          aiSummary.textContent = "ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
          return;
        }

        if (data.status === "TOO_FREQUENT") {
          aiError.textContent = `ìš”ì²­ì´ ë„ˆë¬´ ì¦ìŠµë‹ˆë‹¤. ${data.retry_after_seconds}ì´ˆ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`;
          setAiStatusBadge(null);
          aiSummary.textContent = "ì¿¨ë‹¤ìš´ ë•Œë¬¸ì— ë¶„ì„ì´ ìˆ˜í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
          return;
        }

        if (data.status !== "OK") {
          aiError.textContent = `ì„œë²„ ì‘ë‹µ ìƒíƒœ: ${data.status || "unknown"}`;
          setAiStatusBadge(null);
          aiSummary.textContent = "ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
          return;
        }

        const report = data.ai_report || {};
        const alert = data.alert || {};
        const metricSummary = data.metric_summary || {};

        // ìƒíƒœ ë±ƒì§€
        setAiStatusBadge(report.status);

        // ë©”íƒ€ ì •ë³´
        const period = data.minutes || minutes;
        aiMeta.textContent = `ë¶„ì„ ê¸°ì¤€: ìµœê·¼ ${period}ë¶„ / ì¸ìŠ¤í„´ìŠ¤: ${metricSummary.instance_id || "-"} / ë¦¬ì „: ${metricSummary.region || "-"}`;

        // ìš”ì•½
        aiSummary.textContent = report.summary || "ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";

        // ë¦¬ìŠ¤íŠ¸ë“¤
        renderList("aiCauses", report.suspected_causes || []);
        renderList("aiActions", report.recommended_actions || []);

        // ì•ŒëŒ ì •ë³´
        if (alert.alert_sent) {
          aiAlertInfo.style.display = "inline-flex";
          aiAlertInfo.textContent = `ğŸ”” ì•ŒëŒ ë°œì†¡ë¨: ${alert.subject || ""}`;
        } else {
          aiAlertInfo.style.display = "inline-flex";
          if (alert.reason === "cooldown") {
            aiAlertInfo.textContent = `â± ì•ŒëŒ ì¿¨ë‹¤ìš´ ì¤‘ (ë‚¨ì€ ì‹œê°„: ${alert.cooldown_remaining || 0}ì´ˆ)`;
          } else if (alert.reason === "no_condition_matched") {
            aiAlertInfo.textContent = "â„¹ï¸ ì•ŒëŒ ì¡°ê±´ ë¯¸ì¶©ì¡± (ë°œì†¡ ì•ˆ ë¨)";
          } else {
            aiAlertInfo.textContent = "â„¹ï¸ ì•ŒëŒ ë°œì†¡ ê¸°ë¡ ì—†ìŒ";
          }
        }

        // í‘¸í„°
        lastAnalyzeAt = new Date();
        const kstNow = new Date();
        aiFooter.textContent = `ë§ˆì§€ë§‰ ë¶„ì„: ${kstNow.toLocaleTimeString()} / ì•ŒëŒ ìƒíƒœ: ${
          alert.alert_sent ? "ë°œì†¡ë¨" : "ë°œì†¡ ì•ˆ ë¨"
        }`;

      } catch (err) {
        aiError.textContent = `ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`;
        console.error(err);
        setAiStatusBadge(null);
        aiSummary.textContent = "ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
      } finally {
        btnMain.disabled = false;
        btn60.disabled = false;
        btn240.disabled = false;
      }
    }
  </script>
</body>
</html>
